import{AppError,Filter,flat}from"adminjs";import{Messages}from"../../index.js";export const addManyToManyRelationHandler=a=>async(b,c,d)=>{if("get"===b.method)return c;const{_admin:e,record:f,resource:g}=d,{query:h,payload:i={}}=b,j=flat.unflatten(h||{}),{relation:k}=j,{relations:l}=a,m=l[k],{junction:n}=m;if(!n)throw new AppError(Messages.JunctionMissing);const o=e.findResource(n.throughResourceId),[p]=await o.find(new Filter({[n.joinKey]:d.record?.id(),[n.inverseJoinKey]:i.targetId},o),{limit:1,offset:0,sort:{sortBy:n.joinKey,direction:"asc"}});if(p)throw new AppError(Messages.ManyToManyRelationAlreadyExists);return await o.create({[n.joinKey]:f?.id(),[n.inverseJoinKey]:i.targetId}),{record:f?.toJSON(d.currentAdmin),notice:{type:"success",message:Messages.RelationSuccessfullyAdded,resourceId:g.id()}}};