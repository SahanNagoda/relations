import{AppError,Filter}from"adminjs";import{Messages}from"../../index.js";export const deleteRelationHandler=a=>async(b,c,d)=>{const{record:e,_admin:f,resource:g}=d,{relations:h}=a,i=b.query??{},{relation:j,targetRecordId:k}=i;if(!j||!k||!e)return{record:e?.toJSON?.(d.currentAdmin),notice:{type:"error",message:Messages.QueryParamsMissing,resourceId:g.id()}};const l=h[j],{junction:m}=l;if(!m)throw new AppError(Messages.JunctionMissing);const n=f.findResource(m.throughResourceId);if(!n)throw new AppError(Messages.JunctionResourceMissing,{junctionResourceId:m.throughResourceId},{options:{junctionResourceId:m.throughResourceId}});const[o]=await n.find(new Filter({[m.inverseJoinKey]:k,[m.joinKey]:e.id()},n),{limit:1,offset:0,sort:{sortBy:m.joinKey,direction:"desc"}});if(!o)throw new AppError(Messages.JunctionRecordMissing);return await n.delete(o.id()),{record:e.toJSON(d.currentAdmin),notice:{type:"success",message:Messages.RelationSuccessfullyDeleted,resourceId:g.id()}}};